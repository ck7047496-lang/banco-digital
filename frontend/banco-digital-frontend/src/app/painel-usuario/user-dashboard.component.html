<div class="dashboard-container" *ngIf="isLoggedIn; else notLogged">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="greeting">
      <i class="icon-profile"></i>
      <span>Olá, {{ nomeUsuario }}</span>
    </div>
    <button class="logout-button" (click)="logout()">
      Sair
    </button>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Account Info -->
    <section class="account-info">
      <div class="card balance-card" (click)="openBalanceModal()">
        <div class="card-header">
          <span>Saldo em Conta</span>
          <i class="icon-arrow-up"></i>
        </div>
        <div class="card-body">
          <span class="balance-value">R$ {{ saldo | number:'1.2-2' }}</span>
        </div>
      </div>
      <div class="card credit-card" (click)="openCreditLimitModal()">
        <div class="card-header">
          <span>Limite de Crédito</span>
          <i class="icon-credit-card"></i>
        </div>
        <div class="card-body">
          <span class="credit-value unavailable">Indisponível</span>
        </div>
      </div>
    </section>

    <!-- Recent Activity -->
    <section class="recent-activity">
      <div class="card">
        <div class="card-header">
          <span>Última Movimentação</span>
        </div>
        <div class="card-body">
          <p *ngIf="ultimaMovimentacao">{{ ultimaMovimentacao }}</p>
          <p *ngIf="!ultimaMovimentacao">Nenhuma</p>
        </div>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions">
      <button class="action-button" (click)="openLoanModal()">
        <img src="assets/icons/money-bag.svg" alt="Solicitar Empréstimo">
        <span>Solicitar Empréstimo</span>
      </button>
      <button class="action-button" (click)="openStatementModal()">
        <img src="assets/icons/statement.svg" alt="Ver Extrato">
        <span>Ver Extrato</span>
      </button>
      <button class="action-button" (click)="openCardsModal()">
        <img src="assets/icons/card.svg" alt="Meus Cartões">
        <span>Meus Cartões</span>
      </button>
      <button class="action-button" (click)="openSettingsModal()">
        <img src="assets/icons/gear.svg" alt="Configurações">
        <span>Configurações</span>
      </button>
    </section>

    <!-- Seção de Empréstimos do Usuário -->
    <section class="user-loans">
      <div class="card">
        <div class="card-header">
          <span>Meus Empréstimos</span>
        </div>
        <div class="card-body">
          <div *ngIf="meusEmprestimos.length > 0; else noLoans">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Valor</th>
                  <th>Parcelas</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let emprestimo of meusEmprestimos">
                  <td>{{ emprestimo.id }}</td>
                  <td>{{ emprestimo.valor | currency:'BRL' }}</td>
                  <td>{{ emprestimo.parcelas }}</td>
                  <td>
                    <span [ngClass]="getEmprestimoStatusClass(emprestimo.status)">
                      {{ getEmprestimoStatus(emprestimo.status) }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noLoans>
            <p>Você não possui empréstimos no momento.</p>
          </ng-template>
        </div>
      </div>
    </section>

    <p *ngIf="emprestimoAtivo" class="error-message">Você já possui um empréstimo ativo ou pendente. Apenas um por cliente.</p>

    <!-- Loan Simulation - Modal -->
    <div class="modal-overlay" *ngIf="showLoanForm">
      <div class="modal-content">
        <div class="card">
          <div class="card-header">
            <h2>Solicitar Empréstimo</h2>
            <button class="close-button" (click)="closeLoanModal()">X</button>
          </div>
          <div class="card-body">
            <form [formGroup]="loanForm">
              <div class="form-group">
                <label for="loanValue">Valor do Empréstimo (R$100 - R$10.000)</label>
                <input id="loanValue" type="number" formControlName="value" placeholder="Ex: 1000" class="rounded-input" style="color: black !important;">
                <div *ngIf="loanForm.get('value')?.invalid && (loanForm.get('value')?.dirty || loanForm.get('value')?.touched)" class="validation-hint">
                  Valor inválido. O valor deve ser entre R$100 e R$10.000.
                </div>
              </div>
              <div class="form-group">
                <label for="loanParcels">Número de Parcelas (1-24)</label>
                <input id="loanParcels" type="number" formControlName="parcels" placeholder="Ex: 12" class="rounded-input" style="color: black !important;">
                <div *ngIf="loanForm.get('parcels')?.invalid && (loanForm.get('parcels')?.dirty || loanForm.get('parcels')?.touched)" class="validation-hint">
                  Número de parcelas inválido. As parcelas devem ser entre 1 e 24.
                </div>
              </div>
            </form>

            <!-- Simulation Details inside Loan Modal -->
            <div *ngIf="simulation" class="simulation-details-card">
              <div class="card-header">
                  <h3>Detalhes da Simulação</h3>
              </div>
              <div class="card-body">
                  <p>Valor solicitado: <strong class="visible-number">R$ {{ simulation.value | number:'1.2-2' }}</strong></p>
                  <p>Juros (1%): <strong class="visible-number">R$ {{ simulation.interest | number:'1.2-2' }}</strong></p>
                  <p>Total a pagar: <strong class="visible-number">R$ {{ simulation.total | number:'1.2-2' }}</strong></p>
                  <p>Parcelas: <strong class="visible-number">{{ simulation.parcels }}</strong></p>
                  <p>Valor da parcela: <strong class="visible-number">R$ {{ simulation.parcelValue | number:'1.2-2' }}</strong></p>
                  <p>Finalidade: <strong class="visible-number">{{ simulation.purpose }}</strong></p>
                  <button class="request-loan-button rounded-button" (click)="openConfirmationModal()" [disabled]="loanForm.invalid">Solicitar Empréstimo</button>
              </div>
            </div>
            <p *ngIf="mensagemAprovacao" class="approval-message">{{ mensagemAprovacao }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showConfirmationModal">
      <div class="modal-content">
        <div class="card">
          <div class="card-header">
            <h2>Confirmar Solicitação de Empréstimo</h2>
            <button class="close-button" (click)="closeConfirmationModal()">X</button>
          </div>
          <div class="card-body">
            <p>Você está prestes a solicitar um empréstimo de <strong class="visible-number">R$ {{ simulation.value | number:'1.2-2' }}</strong> em <strong class="visible-number">{{ simulation.parcels }}</strong> parcelas.</p>
            <p>O valor total com juros será de <strong class="visible-number">R$ {{ simulation.total | number:'1.2-2' }}</strong>.</p>
            <p>Deseja confirmar a solicitação?</p>
            <div class="button-group">
              <button class="confirm-button rounded-button" (click)="requestLoan()">Confirmar</button>
              <button class="cancel-button rounded-button" (click)="closeConfirmationModal()">Cancelar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Balance Modal -->
    <div class="modal-overlay" *ngIf="showBalanceModal">
      <div class="modal-content">
        <div class="card">
          <div class="card-header">
            <h2>Detalhes do Saldo</h2>
            <button class="close-button" (click)="closeBalanceModal()">X</button>
          </div>
          <div class="card-body">
            <p>Seu saldo atual é: <strong class="visible-number">R$ {{ saldo | number:'1.2-2' }}</strong></p>
            <p>Informações adicionais sobre o saldo podem ser exibidas aqui.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Credit Limit Modal -->
    <div class="modal-overlay" *ngIf="showCreditLimitModal">
      <div class="modal-content">
        <div class="card">
          <div class="card-header">
            <h2>Detalhes do Limite de Crédito</h2>
            <button class="close-button" (click)="closeCreditLimitModal()">X</button>
          </div>
          <div class="card-body">
            <p *ngIf="true" class="credit-value unavailable">Limite de Crédito: <strong class="visible-number">Indisponível</strong></p>
            <p *ngIf="false" class="credit-value">Limite de Crédito: <strong class="visible-number">R$ 1.500,00</strong></p>
            <p>Informações sobre seu limite de crédito e opções de aumento podem ser exibidas aqui.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Statement Modal -->
    <div class="modal-overlay" *ngIf="showStatementModal">
      <div class="modal-content">
        <div class="card">
          <div class="card-header">
            <h2>Extrato da Conta</h2>
            <button class="close-button" (click)="closeStatementModal()">X</button>
          </div>
          <div class="card-body">
            <p>Aqui você verá seu extrato detalhado.</p>
            <ul>
              <li>Compra no Supermercado: -R$ 150,00</li>
              <li>Pagamento de Salário: +R$ 3.000,00</li>
              <li>Transferência Recebida: +R$ 200,00</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Cards Modal -->
    <div class="modal-overlay" *ngIf="showCardsModal">
      <div class="modal-content">
        <div class="card">
          <div class="card-header">
            <h2>Meus Cartões</h2>
            <button class="close-button" (click)="closeCardsModal()">X</button>
          </div>
          <div class="card-body">
            <p>Gerencie seus cartões aqui.</p>
            <ul>
              <li>Cartão de Crédito Final 1234</li>
              <li>Cartão de Débito Final 5678</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" *ngIf="showSettingsModal">
      <div class="modal-content">
        <div class="card">
          <div class="card-header">
            <h2>Configurações</h2>
            <button class="close-button" (click)="closeSettingsModal()">X</button>
          </div>
          <div class="card-body">
            <p>Ajuste suas configurações de conta.</p>
            <ul>
              <li>Alterar Senha</li>
              <li>Notificações</li>
              <li>Privacidade</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<ng-template #notLogged>
  <div class="not-logged-container">
    <p>Por favor, faça login para acessar o dashboard.</p>
  </div>
</ng-template>